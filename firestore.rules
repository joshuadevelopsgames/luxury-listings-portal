// DEPLOY THIS FILE ONLY. firebase.json points here. Do NOT deploy firestore.rules.production (incomplete - breaks app).
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper: resolve system admins from system_config/admins doc (dynamic, no hardcoded emails)
    // Falls back to legacy hardcoded email for bootstrap safety
    function isAdmin() {
      let adminDoc = get(/databases/$(database)/documents/system_config/admins);
      let dynamicAdmins = adminDoc != null && adminDoc.data != null && 'emails' in adminDoc.data
        ? adminDoc.data.emails
        : [];
      return isAuthenticated() && (
        request.auth.token.email in dynamicAdmins ||
        request.auth.token.email == 'jrsschroeder@gmail.com' ||
        request.auth.token.email == 'demo@luxurylistings.app'
      );
    }

    // Helper: check if user has a specific role by reading their approved_users doc
    function getUserRole() {
      let userDoc = get(/databases/$(database)/documents/approved_users/$(request.auth.token.email));
      return userDoc != null && userDoc.data != null && 'role' in userDoc.data
        ? userDoc.data.role
        : 'pending';
    }

    // Helper: check if user has a specific feature permission
    function hasFeaturePermission(feature) {
      let userDoc = get(/databases/$(database)/documents/approved_users/$(request.auth.token.email));
      return userDoc != null && userDoc.data != null && 'featurePermissions' in userDoc.data
        && feature in userDoc.data.featurePermissions;
    }

    // Helper: check if user has admin-level permissions flag
    function hasAdminPermissions() {
      let userDoc = get(/databases/$(database)/documents/approved_users/$(request.auth.token.email));
      return userDoc != null && userDoc.data != null
        && 'adminPermissions' in userDoc.data
        && userDoc.data.adminPermissions == true;
    }

    // Helper: check if user's role is in the allowed list
    function userRoleIn(allowedRoles) {
      return getUserRole() in allowedRoles;
    }

    // Helper function to get user email
    function getUserEmail() {
      return request.auth.token.email;
    }

    // ===== AUDIT LOG (append-only) =====
    // Anyone authenticated can create audit entries; only admins can read; no updates/deletes
    match /audit_log/{logId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    // ===== SYSTEM CONFIG =====
    // admins doc readable by all authenticated (so isAdmin helper works); writable only by admin
    match /system_config/{configId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Users collection - users can read/write their own data, admins can access all
    match /users/{userId} {
      allow read, write: if isAuthenticated() && 
                            (request.auth.uid == userId || isAdmin());
    }
    
    // Dashboard preferences - users can read/write their own (for Edit Dashboard / widget order)
    // Admins can read any user's preferences (for "View As" feature)
    match /user_dashboard_preferences/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Pending users - authenticated users can read; users can create only their own (so they appear for approval), admins can update/delete
    match /pending_users/{document=**} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.email == request.auth.token.email;
      allow update, delete: if isAdmin();
    }
    
    // Approved users - users can read; admins create/delete; users can create/update own doc (onboarding, My Profile)
    match /approved_users/{userEmail} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() || (isAuthenticated() && request.auth.token.email == userEmail);
      allow delete: if isAdmin();
      allow update: if isAdmin() ||
        (isAuthenticated() && request.auth.token.email == userEmail &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny([
           'role', 'roles', 'primaryRole', 'isApproved', 'email', 'customPermissions',
           'pagePermissions', 'featurePermissions', 'adminPermissions'
         ]));
    }
    
    // Employees - users can create/update their own (onboarding); admins can do anything
    match /employees/{employeeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.email == request.auth.token.email;
      allow update: if isAuthenticated() && (resource.data.email == request.auth.token.email || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Tasks - authenticated users can read/write (team collaboration)
    match /tasks/{taskId} {
      allow read, write: if isAuthenticated();
    }
    
    // Task templates - per-user: owner can read/write; shared users can read only
    // sharedWith is stored lowercase; email_lower custom claim allows case-insensitive shared read
    match /task_templates/{templateId} {
      allow read: if isAuthenticated() &&
        (resource.data.ownerEmail == request.auth.token.email ||
         ('sharedWith' in resource.data && (
           request.auth.token.email in resource.data.sharedWith ||
           (request.auth.token.email_lower != null && request.auth.token.email_lower in resource.data.sharedWith)
         )));
      allow create: if isAuthenticated() && request.resource.data.ownerEmail == request.auth.token.email;
      allow update, delete: if isAuthenticated() && resource.data.ownerEmail == request.auth.token.email;
    }
    
    // Smart filters - authenticated users can read/write
    match /smart_filters/{filterId} {
      allow read, write: if isAuthenticated();
    }
    
    // Shared CRM data (leads) - any authenticated can read/write so leads show for everyone
    match /crm/{docId} {
      allow read, write: if isAuthenticated();
    }
    
    // Clients - any authenticated can read; writes restricted to roles with client management
    match /clients/{clientId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        isAdmin() ||
        hasAdminPermissions() ||
        userRoleIn(['admin', 'director', 'content_director', 'social_media_manager', 'sales_manager'])
      );
    }
    
    // System doc for monthly posts reset (last year-month). Read: any authenticated; write: admin only.
    match /system/posts_reset {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Monthly post log history (snapshots at reset). Read: any authenticated; write: admin only (via reset).
    match /post_log_monthly/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Client movements (deletions, reassignments, added) - for HR analytics. Read: any authenticated (page is permission-gated).
    match /client_movements/{movementId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // Client health snapshots (monthly AI health run). Read: any authenticated (Client Health / My Clients are permission-gated).
    match /client_health_snapshots/{clientId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    // Client contracts - any authenticated can read; writes restricted to client-managing roles
    match /client_contracts/{contractId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        isAdmin() ||
        hasAdminPermissions() ||
        userRoleIn(['admin', 'director', 'content_director', 'social_media_manager', 'sales_manager'])
      );
    }
    
    // Client messages - authenticated users can read/write
    match /client_messages/{messageId} {
      allow read, write: if isAuthenticated();
    }
    
    // Client reports - authenticated users can read, authenticated users can write
    match /client_reports/{reportId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Pending clients - any authenticated can read; writes restricted to client-managing roles
    match /pending_clients/{clientId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        isAdmin() ||
        hasAdminPermissions() ||
        userRoleIn(['admin', 'director', 'content_director', 'social_media_manager', 'sales_manager'])
      );
    }
    
    // Analytics config - authenticated users can read, admins can write
    match /analytics_config/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Support tickets - authenticated users can read/write
    match /support_tickets/{ticketId} {
      allow read, write: if isAuthenticated();
    }
    
    // Ticket comments - authenticated users can read/write
    match /ticket_comments/{commentId} {
      allow read, write: if isAuthenticated();
    }
    
    // Notifications - authenticated users can read/write their own
    match /notifications/{notificationId} {
      allow read, write: if isAuthenticated();
    }
    
    // Task requests - authenticated users can read/write
    match /task_requests/{requestId} {
      allow read, write: if isAuthenticated();
    }
    
    // Per-user task/request archive preferences (which tasks/requests user has archived locally)
    match /user_task_archives/{docId} {
      allow read: if isAuthenticated() && resource.data.userEmail == request.auth.token.email;
      allow create: if isAuthenticated() && request.resource.data.userEmail == request.auth.token.email;
      allow update, delete: if isAuthenticated() && resource.data.userEmail == request.auth.token.email;
    }
    
    // Leave requests - any authenticated can read; create own requests; only HR/admin can approve/update others
    match /leave_requests/{requestId} {
      allow read: if isAuthenticated();
      // Anyone can create their own leave request
      allow create: if isAuthenticated();
      // Updates: owner can edit own pending request; HR/admin can approve/reject any
      allow update: if isAuthenticated() && (
        isAdmin() ||
        userRoleIn(['admin', 'hr_manager']) ||
        (resource.data.userEmail == request.auth.token.email && resource.data.status == 'pending')
      );
      // Delete: admin/HR only
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        userRoleIn(['admin', 'hr_manager'])
      );
    }
    
    // Graphic projects - authenticated users can read/write (design team collaboration)
    match /graphic_projects/{projectId} {
      allow read, write: if isAuthenticated();
    }
    
    // Project requests - authenticated users can create, designers can read their requests
    match /project_requests/{requestId} {
      allow read, write: if isAuthenticated();
    }
    
    // Feedback - authenticated users can create, admin can read all
    match /feedback/{feedbackId} {
      allow read, write: if isAuthenticated();
    }
    
    // Feedback chats - users can read/write their own chats, admin can read all
    match /feedback_chats/{chatId} {
      allow read, write: if isAuthenticated();
    }
    
    // Instagram reports - public read (for shareable client links); list/edit/delete scoped by userId in app
    match /instagram_reports/{reportId} {
      allow read: if true;  // Public read so share links work without auth; app filters list by userId
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin() || hasAdminPermissions());
    }
    
    // Error reports - ANYONE can create (even unauthenticated), only admin can read/update
    match /error_reports/{reportId} {
      allow create: if true;  // Anyone can submit error reports (even before login)
      allow read, update, delete: if isAdmin();  // Only admin can view/manage reports
    }
    
    // Client templates - synced from Canva, authenticated users can read, admins can write
    // Cloud Functions write via Admin SDK (bypasses rules)
    match /client_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Generated designs - created by render engine, users can read/create
    match /generated_designs/{designId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        resource.data.created_by == request.auth.token.email;
    }
    
    // Usage analytics - any authenticated user can log; only admins can read (System Admin page)
    match /usage_events/{eventId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
      allow update, delete: if false;
    }
    
    // Canvases (workspaces) - owner can do anything; shared users can read and update (edit)
    match /canvases/{canvasId} {
      allow read, update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        ('sharedWithEmails' in resource.data && (
          request.auth.token.email in resource.data.sharedWithEmails ||
          (request.auth.token.email_lower != null && request.auth.token.email_lower in resource.data.sharedWithEmails)
        ))
      );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Block comments and reactions - same access as parent canvas (owner + shared)
      match /block_comments/{blockId} {
        allow read, write: if isAuthenticated() && (
          get(/databases/$(database)/documents/canvases/$(canvasId)).data.userId == request.auth.uid ||
          ('sharedWithEmails' in get(/databases/$(database)/documents/canvases/$(canvasId)).data && (
            request.auth.token.email in get(/databases/$(database)/documents/canvases/$(canvasId)).data.sharedWithEmails ||
            (request.auth.token.email_lower != null && request.auth.token.email_lower in get(/databases/$(database)/documents/canvases/$(canvasId)).data.sharedWithEmails)
          ))
        );
      }
    }
    
    // Content calendar - users can read/write their own calendars and items
    match /content_calendars/{calendarId} {
      allow read, update, delete: if isAuthenticated() && resource.data.userEmail == request.auth.token.email;
      allow create: if isAuthenticated() && request.resource.data.userEmail == request.auth.token.email;
    }
    // Content items - owner can CRUD; admins/directors can read all and update status (approval workflow)
    match /content_items/{itemId} {
      allow read: if isAuthenticated() && (
        resource.data.userEmail == request.auth.token.email ||
        isAdmin() ||
        userRoleIn(['admin', 'director', 'content_director'])
      );
      allow create: if isAuthenticated() && request.resource.data.userEmail == request.auth.token.email;
      allow update: if isAuthenticated() && (
        resource.data.userEmail == request.auth.token.email ||
        isAdmin() ||
        userRoleIn(['admin', 'director', 'content_director'])
      );
      allow delete: if isAuthenticated() && (
        resource.data.userEmail == request.auth.token.email ||
        isAdmin()
      );
    }
    
    // Announcements - all authenticated can read; only admins can write
    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Custom roles - admin read/write for role management
    match /custom_roles/{roleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Rate limits - Cloud Functions manage these via Admin SDK; no client access
    match /rate_limits/{docId} {
      allow read, write: if false;
    }

    // API usage logs - Cloud Functions manage; admin read only
    match /api_usage_logs/{docId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    // Catch-all: deny access to any collection not explicitly listed above
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

