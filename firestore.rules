rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             (request.auth.token.email == 'jrsschroeder@gmail.com' ||
              request.auth.token.email == 'demo@luxurylistings.app');
    }
    
    // Helper function to get user email
    function getUserEmail() {
      return request.auth.token.email;
    }
    
    // Users collection - users can read/write their own data, admins can access all
    match /users/{userId} {
      allow read, write: if isAuthenticated() && 
                            (request.auth.uid == userId || isAdmin());
    }
    
    // Dashboard preferences - users can read/write their own (for Edit Dashboard / widget order)
    // Admins can read any user's preferences (for "View As" feature)
    match /user_dashboard_preferences/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Pending users - authenticated users can read, admins can write
    match /pending_users/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Approved users - authenticated users can read, admins can write
    match /approved_users/{userEmail} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Employees - authenticated users can read, admins can write
    match /employees/{employeeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Tasks - authenticated users can read/write (team collaboration)
    match /tasks/{taskId} {
      allow read, write: if isAuthenticated();
    }
    
    // Task templates - authenticated users can read, admins can write
    match /task_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Smart filters - authenticated users can read/write
    match /smart_filters/{filterId} {
      allow read, write: if isAuthenticated();
    }
    
    // Clients - authenticated users can read, authenticated users can write
    // TODO: Add role-based check (only Social Media Managers and Admins should write)
    match /clients/{clientId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Client contracts - authenticated users can read, authenticated users can write
    // TODO: Add role-based check (only Social Media Managers and Admins should write)
    match /client_contracts/{contractId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Client messages - authenticated users can read/write
    match /client_messages/{messageId} {
      allow read, write: if isAuthenticated();
    }
    
    // Client reports - authenticated users can read, authenticated users can write
    match /client_reports/{reportId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Pending clients - authenticated users can read, authenticated users can write
    // TODO: Add role-based check (only Social Media Managers and Admins should write)
    match /pending_clients/{clientId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Analytics config - authenticated users can read, admins can write
    match /analytics_config/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // System config - authenticated users can read, admins can write
    match /system_config/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Support tickets - authenticated users can read/write
    match /support_tickets/{ticketId} {
      allow read, write: if isAuthenticated();
    }
    
    // Ticket comments - authenticated users can read/write
    match /ticket_comments/{commentId} {
      allow read, write: if isAuthenticated();
    }
    
    // Notifications - authenticated users can read/write their own
    match /notifications/{notificationId} {
      allow read, write: if isAuthenticated();
    }
    
    // Task requests - authenticated users can read/write
    match /task_requests/{requestId} {
      allow read, write: if isAuthenticated();
    }
    
    // Per-user task/request archive preferences (which tasks/requests user has archived locally)
    match /user_task_archives/{docId} {
      allow read: if isAuthenticated() && resource.data.userEmail == request.auth.token.email;
      allow create: if isAuthenticated() && request.resource.data.userEmail == request.auth.token.email;
      allow update, delete: if isAuthenticated() && resource.data.userEmail == request.auth.token.email;
    }
    
    // Leave requests - authenticated users can read, authenticated users can write
    // TODO: Add HR role check for write operations
    match /leave_requests/{requestId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Graphic projects - authenticated users can read/write (design team collaboration)
    match /graphic_projects/{projectId} {
      allow read, write: if isAuthenticated();
    }
    
    // Project requests - authenticated users can create, designers can read their requests
    match /project_requests/{requestId} {
      allow read, write: if isAuthenticated();
    }
    
    // Feedback - authenticated users can create, admin can read all
    match /feedback/{feedbackId} {
      allow read, write: if isAuthenticated();
    }
    
    // Feedback chats - users can read/write their own chats, admin can read all
    match /feedback_chats/{chatId} {
      allow read, write: if isAuthenticated();
    }
    
    // Instagram reports - public read (for shareable client links); list/edit/delete scoped by userId in app
    match /instagram_reports/{reportId} {
      allow read: if true;  // Public read so share links work without auth; app filters list by userId
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Error reports - ANYONE can create (even unauthenticated), only admin can read/update
    match /error_reports/{reportId} {
      allow create: if true;  // Anyone can submit error reports (even before login)
      allow read, update, delete: if isAdmin();  // Only admin can view/manage reports
    }
    
    // Client templates - synced from Canva, authenticated users can read, admins can write
    // Cloud Functions write via Admin SDK (bypasses rules)
    match /client_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Generated designs - created by render engine, users can read/create
    match /generated_designs/{designId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        resource.data.created_by == request.auth.token.email;
    }
    
    // Note: The catch-all rule below is commented out to maintain current functionality
    // Uncomment it once you've verified all collections are explicitly listed above
    // match /{document=**} {
    //   allow read, write: if false;
    // }
  }
}

